YUI.add("moodle-atto_eexcesseditor-button",function(e,t){e.namespace("M.atto_eexcesseditor").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{selectedRec:[],citationStyles:[],initializer:function(){var e=this;e.citationStyles=this.get("citStyles");var t=[];for(var n=0;n<e.citationStyles.length;n++){var r={text:e.citationStyles[n].name,callback:e.onToolbarMenuItemClick};t.push(r)}t.push({text:"Insert Link",callback:e.insertLink}),t.push({text:"Insert Image",callback:e.insertImage}),this.addButton({icon:"icon",iconComponent:"atto_eexcesseditor",buttonName:"eexcesseditor",callback:this.onButtonClick}),this.addToolbarMenu({icon:"iconcitstyles",iconComponent:"atto_eexcesseditor",callback:function(){},items:t}),window.addEventListener("message",function(t){t.data.event=="eexcess.selectionChanged"?(e.selectedRec=[],e.selectedRec=t.data.selected):t.data.event=="eexcess.queryTriggered"&&(e.selectedRec=[])}),this.get("host").editor.on("key",function(){var t=e.getText();window.console.log('Querying for text: "'+t+'"'),window.postMessage({event:"eexcess.paragraphEnd",text:e.getText()},"*")},"enter")},insertLink:function(){var e=this.get("host"),t=this.selectedRec;this.lastUsedCitationStyle="insertLink";if(!t.length)return window.console.log("Nothing is selected"),!1;for(var n=0;n<t.length;n++){var r=t[n],i='<a href =""'+r.uri+">"+r.title+"</a> ";e.insertContentAtFocusPoint(i+"</br>")}},insertImage:function(){var e=this.get("host"),t=this.selectedRec;this.lastUsedCitationStyle="insertImage";if(!t.length)return window.console.log("Nothing is selected"),!1;for(var n=0;n<t.length;n++){var r=window.document.createElement("img"),i=t[n];r.src=i.previewImage;if(r.src!==i.previewImage){var s=t[n],o='<a href =""'+s.uri+">"+s.title+"</a> ";e.insertContentAtFocusPoint(o+"</br>")}else e.insertContentAtFocusPoint(r.outerHTML+"</br>"),window.console.log(r)}},onButtonClick:function(){this.requireCitations()},onToolbarMenuItemClick:function(e){var t=e.target.getData("index"),n=this.citationStyles[t].style;window.console.log(n),this.requireCitations(n)},requireCitations:function(e){if(!this.selectedRec.length)return window.console.log("Nothing is selected"),!1;var t=this;require(["local_eexcess/citationBuilder"],function(n){var r=t.parseRecToCitation(t.selectedRec),i=null;window.console.log("selected records");if(typeof e=="undefined"){e=t.lastUsedCitationStyle;if(e=="insertImage"){t.insertImage();return}if(e=="insertLink"){t.insertLink();return}}typeof e=="undefined"?i=n(r):(t.lastUsedCitationStyle=e,i=n(r,undefined,e)),t.insertCitations(i)})},parseRecToCitation:function(e){var t={};for(var n=0;n<e.length;n++){var r=e[n],i=typeof r.id=="undefined"?"":r.id,s=typeof r.collectionName=="undefined"?"":r.collectionName,o=typeof r.uri=="undefined"?"":r.uri,u=typeof r.title=="undefined"?"":r.title,a=typeof r.creator=="undefined"?"":r.creator,f=typeof r.facets.year=="undefined"?"":r.facets.year,l={id:i,"container-title":s,URL:o,title:u,author:[{family:a}],issued:{"date-parts":[[f]]}};t[l.id]=l}return t},insertCitations:function(e){var t=this.get("host");for(var n=0;n<e.length;n++){var r=e[n];t.insertContentAtFocusPoint(r+"<br>")}},getText:function(){var e=this.get("host"),t=this.getNodesUntilCursor(e.editor.getDOMNode()),n=null;for(var r=t.childNodes.length-1;r>-1;r--){var i=t.childNodes[r];i.textContent.length>0&&(n=i.textContent,r=-1)}return n},getNodesUntilCursor:function(e){var t=0;if(typeof window.getSelection!="undefined"){var n=window.getSelection().getRangeAt(0),r=n.cloneRange();return r.selectNodeContents(e),r.setEnd(n.endContainer,n.endOffset),t=r.toString().length,r.cloneContents()}if(typeof document.selection!="undefined"&&document.selection.type!="Control"){var i=document.selection.createRange(),s=document.body.createTextRange();return s.moveToElementText(e),s.setEndPoint("EndToEnd",i),t=s.text.length,s.cloneContents()}}},{ATTRS:{citStyles:{value:!1}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
